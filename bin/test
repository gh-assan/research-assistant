#!/usr/bin/env ruby

$LOAD_PATH.unshift(File.expand_path('../../lib', __FILE__))
require 'research_assistant'
require 'securerandom'

def main
  topic = ARGV[0] || "sky"
  research_id = SecureRandom.uuid

  article = ''

  # Initialize components
  api_client = ResearchAssistant::OllamaInterface::ApiClient.new
  json_api_client = ResearchAssistant::OllamaInterface::JsonApiClient.new
  writer_api_client = ResearchAssistant::OllamaInterface::WriterApiClient.new
  file_manager = ResearchAssistant::KnowledgeBase::FileManager.new(research_id)
  concept_extractor = ResearchAssistant::CoreEngine::ConceptExtractor.new(api_client, json_api_client)
  relations_finder = ResearchAssistant::CoreEngine::RelationsFinder.new(api_client, json_api_client)
  user_intent_extractor = ResearchAssistant::CoreEngine::UserIntentExtractor.new(json_api_client)
  response_analyzer = ResearchAssistant::CoreEngine::ResponseAnalyzer.new(api_client, json_api_client)
  concept_updater = ResearchAssistant::CoreEngine::ConceptUpdater.new(concept_extractor)
  gap_detector = ResearchAssistant::CoreEngine::GapDetector.new(api_client, json_api_client)
  output_generator = ResearchAssistant::Output::OutputGenerator.new(writer_api_client)
  knowledge_integrator = ResearchAssistant::CoreEngine::KnowledgeIntegrator.new(
    response_analyzer: response_analyzer,
    concept_updater: concept_updater,
    gap_detector: gap_detector
  )
  question_engine = ResearchAssistant::CoreEngine::QuestionEngine.new(api_client, json_api_client)
  iteration_manager = ResearchAssistant::CoreEngine::IterationManager.new(
    api_client: api_client,
    file_manager: file_manager,
    question_engine: question_engine,
    knowledge_integrator: knowledge_integrator
  )

  pp "Run research on topic: #{topic}"

  prompt = user_intent_extractor.create_prompt(topic)
  pp prompt

  questions = question_engine.extract(prompt)
  # pp questions

  # Run research
  concepts = concept_extractor.extract(topic, article)

  # pp "Concepts :" + analysis.inspect

  insights = response_analyzer.analyze(topic, article)

  # insights = response_analyzer.analyze(topic, analysis)

  # file_manager.save_analysis(analysis)

  # iteration_manager.run(analysis)

  # pp analysis.inspect

  gaps = gap_detector.detect(topic, article)

  # pp gaps.inspect

  relations = relations_finder.find_relations(topic, article, insights)

  # pp relations.inspect

  article = output_generator.generate_article(topic, article, prompt, insights ,gaps, concepts, relations, questions)

  pp article
end

main if __FILE__ == $0