#!/usr/bin/env ruby

$LOAD_PATH.unshift(File.expand_path('../../lib', __FILE__))
require 'research_assistant'
require 'securerandom'

def main
  topic = ARGV[0] || "sky"
  research_id = SecureRandom.uuid

  # Initialize components
  api_client = ResearchAssistant::OllamaInterface::ApiClient.new
  json_api_client = ResearchAssistant::OllamaInterface::JsonApiClient.new
  file_manager = ResearchAssistant::KnowledgeBase::FileManager.new(research_id)
  concept_extractor = ResearchAssistant::CoreEngine::ConceptExtractor.new(api_client, json_api_client)
  response_analyzer = ResearchAssistant::CoreEngine::ResponseAnalyzer.new(api_client, json_api_client)
  concept_updater = ResearchAssistant::CoreEngine::ConceptUpdater.new(concept_extractor)
  gap_detector = ResearchAssistant::CoreEngine::GapDetector.new(api_client)
  knowledge_integrator = ResearchAssistant::CoreEngine::KnowledgeIntegrator.new(
    response_analyzer: response_analyzer,
    concept_updater: concept_updater,
    gap_detector: gap_detector
  )
  question_engine = ResearchAssistant::CoreEngine::QuestionEngine.new(api_client: api_client)
  iteration_manager = ResearchAssistant::CoreEngine::IterationManager.new(
    api_client: api_client,
    file_manager: file_manager,
    question_engine: question_engine,
    knowledge_integrator: knowledge_integrator
  )

  # Run research
  analysis = concept_extractor.extract(topic)
  file_manager.save_analysis(analysis)

  iteration_manager.run(analysis)
end

main if __FILE__ == $0